SELECT
  sc.id,
  sc.state,
  sc.statestarttime,
  sc.deadlinetime,
  sc.deadline,
  sc.timeallowancetimers,
  sc.timeallowancetimerb,
  sc.timeallowancetimerd,

  /* Дедлайн из timerD (epoch ms -> Владивосток +10) */
  CASE
    WHEN sc.timeallowancetimerd IS NOT NULL AND sc.timeallowancetimerd > 0
    THEN (
      TO_TIMESTAMP_TZ('1970-01-01 00:00:00 UTC', 'YYYY-MM-DD HH24:MI:SS TZR')
      + NUMTODSINTERVAL(sc.timeallowancetimerd/1000, 'SECOND')
    ) AT TIME ZONE '+10:00'
  END AS timer_deadline_vl,

  /* Остаток по таймеру (в секундах), если есть B и D */
  CASE
    WHEN sc.timeallowancetimerd IS NOT NULL AND sc.timeallowancetimerb IS NOT NULL AND sc.timeallowancetimerb > 0
    THEN (sc.timeallowancetimerd - sc.timeallowancetimerb) / 1000
  END AS remaining_sec
FROM nausd40.tbl_servicecall sc
WHERE sc.id = {{id}};
